<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://perevillega.com name=base><title>Software serves the Business • Using Redis PubSub with Play 2.1.0</title><link href=https://perevillega.com/icons/favicon.ico rel=icon type=image/png><link title="Software serves the Business - Atom Feed" href=https://perevillega.com/atom.xml rel=alternate type=application/atom+xml><link href="https://perevillega.com/inter_subset_en.css?h=d8cf4ad058d6c3a4015b" rel=stylesheet><link href="https://perevillega.com/main.css?h=149ff9e737409b86f9c3" rel=stylesheet><meta content="light dark" name=color-scheme><meta content=#087e96 name=theme-color><meta content="Last week I was experimenting a bit with Redis and its Publish-Subscribe module. The idea was to try to implement a chat with it (something I’ll need for my next project) and from all the options I evaluated this seemed the best. Loving Redis so far, whoever called it the swiss-knife of databases was completely right.
…" name=description><meta content="Last week I was experimenting a bit with Redis and its Publish-Subscribe module. The idea was to try to implement a chat with it (something I’ll need for my next project) and from all the options I evaluated this seemed the best. Loving Redis so far, whoever called it the swiss-knife of databases was completely right.
…" property=og:description><meta content="index, nofollow" name=robots><meta content="Using Redis PubSub with Play 2.1.0" property=og:title><meta content=article property=og:type><meta content="https://perevillega.com/social_cards/index.png?h=125d02cc3c86eaf88fa6" property=og:image><meta content=2088 property=og:image:width><meta content=1000 property=og:image:height><meta content="https://perevillega.com/social_cards/index.png?h=125d02cc3c86eaf88fa6" name=twitter:image><meta content=summary_large_image name=twitter:card><meta content=en_GB property=og:locale><meta content=https://perevillega.com/posts/using-redis-pubsub-with-play-2-dot-1-0/ property=og:url><meta content="Software serves the Business" property=og:site_name><meta content="default-src 'self';font-src 'self' data: 'self';img-src 'self' https://* data:;media-src 'self' https://cdn.jsdelivr.net/;style-src 'self' 'unsafe-inline';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self' https://umami.villegawilcz.com;script-src 'self' https://umami.villegawilcz.com 'self'" http-equiv=Content-Security-Policy><noscript><link href=https://perevillega.com/no_js.css rel=stylesheet></noscript><script src=https://perevillega.com/js/initializeTheme.min.js></script><script defer src=https://perevillega.com/js/themeSwitcher.min.js></script><script async data-do-not-track=true data-website-id=7bdfa858-bebc-479d-9a1f-bea833a709a8 defer src=https://umami.villegawilcz.com/script.js></script><meta content=@pvillega@mastodon.social name=fediverse:creator><script src="https://perevillega.com/search_index.en.js?h=791a6da9678059241bea" defer></script><script src="https://perevillega.com/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://perevillega.com>Software serves the Business</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://perevillega.com/posts/> blog </a><li><a class="nav-links no-hover-padding" href=https://perevillega.com/tags/> tags </a></li><div class=nav-navs id=menu-icons-group><li class=js><div aria-label="Click or press $SHORTCUT to open search" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" id=search-button role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" class="theme-resetter arrow" title="Reset mode to default" aria-hidden=true role=button tabindex=0></div></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>Using Redis PubSub with Play 2.1.0</h1><ul class=meta><li>24th Feb 2013<li title="564 words"><span aria-hidden=true class=separator>•</span>3 min read<li class=tag><span aria-hidden=true class=separator>•</span>Tags: <li class=tag><a href=https://perevillega.com/tags/scala/>scala</a>, <li class=tag><a href=https://perevillega.com/tags/play2/>play2</a>, <li class=tag><a href=https://perevillega.com/tags/redis/>redis</a>, <li class=tag><a href=https://perevillega.com/tags/pubsub/>pubsub</a></ul><section class=body><p>Last week I was experimenting a bit with <a href=http://redis.io/ rel=noopener target=_blank>Redis</a> and its <a href=http://redis.io/topics/pubsub rel=noopener target=_blank>Publish-Subscribe</a> module. The idea was to try to implement a chat with it (something I’ll need for my next project) and from all the options I evaluated this seemed the best. Loving Redis so far, whoever called it the swiss-knife of databases was completely right.</p><span id=continue-reading></span><p>As to be expected with programming I had some trouble, in this scenario using Redis PubSub with Play 2.1.0 blocked the application. So I decided to publish this in case someone else has the same issue. If you don’t want to read the details just go to the <a href=https://github.com/pvillega/play21-redis-pubsub rel=noopener target=_blank>GitHub repository</a> and clone the source. It contains a very simple application in which Play subscribes to a Redis channel and sends messages to it via Akka actors, while using a listener to notify about reception of the same messages. The <code>Readme</code> file gives more detail on how it works.<p>So now let’s talk about Redis and the issue I had.<h2 id=using-redis-with-play><a aria-label="Anchor link for: using-redis-with-play" class="header-anchor no-hover-padding" href=#using-redis-with-play><span aria-hidden=true class=link-icon></span></a> Using Redis with Play</h2><p>Using Redis with Play is very straightforward. Typesafe provides a <a href=https://github.com/typesafehub/play-plugins/tree/master/redis rel=noopener target=_blank>play plugin</a> to manage the interactions. The plugin is based on <a href=https://github.com/pk11/sedis rel=noopener target=_blank>Sedis</a>, the Scala library for Redis, which in turn is a wrapper over <a href=https://github.com/xetorthio/jedis/ rel=noopener target=_blank>Jedis</a>, the most popular JVM library for Redis.<p>At the time of this writing the dependencies for Play 2.1 are not working perfectly so you need to add an additional resolver to your project to be able to download all of them:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">resolvers += <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>org.sedis<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span> at <span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>http://pk11-scratch.googlecode.com/svn/trunk<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span>
</span></code></pre><p>but once done you can use Redis as both Cache layer and Database for Play.<h2 id=the-issue><a aria-label="Anchor link for: the-issue" class="header-anchor no-hover-padding" href=#the-issue><span aria-hidden=true class=link-icon></span></a> The issue</h2><p>Simple as it is, things got a bit more complex when using PubSub. The way PubSub works with Redis is as follows:<ul><li>first of all you set a client to subscribe to a channel. The subscription call accepts a listener class that will trigger method calls as response to events in the channel (messages being passed around, etc.)<li>then you need clients to send messages to the channel via the <code>publish</code> operation.</ul><p>So the resulting code for subscription would be something like this:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala">pool<span class="z-punctuation z-accessor z-scala">.</span>withJedisClient<span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">client</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=></span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  client<span class="z-punctuation z-accessor z-scala">.</span>subscribe<span class="z-punctuation z-section z-group z-begin z-scala">(</span>listener<span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-constant z-scala">CHANNEL</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p>but as it happens <code>subscribe</code> is a blocking call. This means that every time we execute it, a thread will be locked into receiving notifications from Redis. And the result is that Play will stop working as all threads get consumed by calls to this operation.<h2 id=solution><a aria-label="Anchor link for: solution" class="header-anchor no-hover-padding" href=#solution><span aria-hidden=true class=link-icon></span></a> Solution</h2><p>Thankfully Play 2.1.0 introduces a new concept that solves this issue: <a href=http://www.playframework.com/documentation/2.1.0/ThreadPools rel=noopener target=_blank>ExecutionContexts</a>. An <code>ExecutionContext</code> is nothing more than a set of threads, independent from the ones managing the Play app itself, to be used when we have slow or blocking operations. This ensures some specialized thread takes care of that operation without impacting the performance of the application itself.<p>In our case, as we have a blocking call, we simply want to run the <code>subscribe</code> operation inside its own <code>ExecutionContext</code>, which will consist on threads devoted to listening to Redis, while the standard <code>ExecutionContext</code> manages other Play calls. So our code will become as follows:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-meta z-class z-identifier z-scala"><span class="z-storage z-type z-class z-scala">object</span><span class="z-entity z-name z-class z-scala"> Contexts</span></span> <span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala">  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> Execution context used to avoid blocking on subscribe</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala">  <span class="z-storage z-modifier z-other z-scala">implicit</span> <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">myExecutionContext</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">ExecutionContext</span> <span class="z-keyword z-operator z-assignment z-scala">=</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala"><span class="z-support z-constant z-scala">Akka</span><span class="z-punctuation z-accessor z-scala">.</span>system<span class="z-punctuation z-accessor z-scala">.</span>dispatchers<span class="z-punctuation z-accessor z-scala">.</span>lookup<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-string z-quoted z-double z-scala"><span class="z-punctuation z-definition z-string z-begin z-scala">"</span>akka.actor.redis-pubsub-context<span class="z-punctuation z-definition z-string z-end z-scala">"</span></span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-class z-body z-scala"><span class="z-punctuation z-section z-braces z-end z-scala">}</span></span>
</span><span class="z-source z-scala">
</span><span class="z-source z-scala"><span class="z-support z-constant z-scala">Future</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> subscribe in a Future using a specific ExecutionContext</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-comment z-line z-double-slash z-scala"><span class="z-punctuation z-definition z-comment z-scala">//</span> use Sedis pool to launch the subscribe operation</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  pool<span class="z-punctuation z-accessor z-scala">.</span>withJedisClient<span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span> <span class="z-variable z-parameter z-scala">client</span> <span class="z-storage z-type z-function z-arrow z-lambda z-scala">=></span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    client<span class="z-punctuation z-accessor z-scala">.</span>subscribe<span class="z-punctuation z-section z-group z-begin z-scala">(</span>listener<span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-constant z-scala">CHANNEL</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span></span><span class="z-meta z-group z-scala"><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-support z-constant z-scala">Contexts</span><span class="z-punctuation z-accessor z-scala">.</span>myExecutionContext<span class="z-punctuation z-section z-group z-end z-scala">)</span></span>
</span></code></pre><p>And that’s it. A simple way to avoid blocking operations slowing your app or consuming all the threads it needs. If you’ve had this issue this will solve it for you.</section><nav class="full-width article-navigation"><div><a aria-describedby=left_title aria-label=Next href=https://perevillega.com/posts/using-ansible-to-deploy-play-framework-apps-in-ec2-instances/><span class=arrow>←</span> Next</a><p aria-hidden=true id=left_title>Using Ansible to deploy Play Framework apps in EC2 instances</div><div><a aria-describedby=right_title aria-label=Prev href=https://perevillega.com/posts/executing-jasmine-tests-in-play-2-dot-0-4/>Prev <span class=arrow>→</span></a><p aria-hidden=true id=right_title>Executing Jasmine Tests in Play 2.0.4</div></nav></article></main><script defer src=https://perevillega.com/js/mermaid.min.js></script><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://perevillega.com/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://perevillega.com/atom.xml rel=noopener target=_blank> <img alt=feed loading=lazy src=https://perevillega.com/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email=cHZpbGxlZ2ErYmxvZ0BhcmFjb24uY29t href=#><img alt=email loading=lazy src=https://perevillega.com/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://github.com/pvillega target=_blank> <img alt=github loading=lazy src=https://perevillega.com/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://gitlab.com/pvillega target=_blank> <img alt=gitlab loading=lazy src=https://perevillega.com/social_icons/gitlab.svg title=gitlab> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://bsky.app/profile/perevillega.com target=_blank> <img alt=bluesky loading=lazy src=https://perevillega.com/social_icons/bluesky.svg title=bluesky> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://www.linkedin.com/in/perevillega/ target=_blank> <img alt=linkedin loading=lazy src=https://perevillega.com/social_icons/linkedin.svg title=linkedin> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://stackoverflow.com/users/116791/pere-villega target=_blank> <img alt="stack overflow" title="stack overflow" loading=lazy src=https://perevillega.com/social_icons/stack-overflow.svg> </a></ul></nav><nav class=nav-navs><small> <ul><li><a class="nav-links no-hover-padding" href=https://perevillega.com/sitemap.xml> sitemap </a></ul> </small></nav><div class=credits><small> Powered by <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> & <a href=https://github.com/welpo/tabi rel=noopener target=_blank>tabi</a> </small></div></section><script async src=https://perevillega.com/js/decodeMail.min.js></script><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><h1 class=visually-hidden id=modalTitle>Search</h1><div id=modal-content><div id=searchBar><div aria-hidden=true class=search-icon><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search… role=combobox spellcheck=false><div class="close-icon interactive-icon" title="Clear search" id=clear-search role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></div></div><div id=results-container><div id=results-info><span id=zero_results> No results</span><span id=one_results> $NUMBER result</span><span id=many_results> $NUMBER results</span><span id=two_results> $NUMBER results</span><span id=few_results> $NUMBER results</span></div><div id=results role=listbox></div></div></div></div></footer>