<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://perevillega.com name=base><title>Software serves the Business • Free Monads and Stockfighter</title><link href=https://perevillega.com/icons/favicon.ico rel=icon type=image/png><link title="Software serves the Business - Atom Feed" href=https://perevillega.com/atom.xml rel=alternate type=application/atom+xml><link href="https://perevillega.com/inter_subset_en.css?h=d8cf4ad058d6c3a4015b" rel=stylesheet><link href="https://perevillega.com/main.css?h=149ff9e737409b86f9c3" rel=stylesheet><meta content="light dark" name=color-scheme><meta content=#087e96 name=theme-color><meta content="StockFighter is a game by Patrick McKenzie (Hi Patrick!) and others that makes you compete in a virtual Stock Exchange to accomplish certain objectives. They use it as a recruitment tool (kind of, read their website) but it’s a very entertaining game, even if you are not looking for a new job.
…" name=description><meta content="StockFighter is a game by Patrick McKenzie (Hi Patrick!) and others that makes you compete in a virtual Stock Exchange to accomplish certain objectives. They use it as a recruitment tool (kind of, read their website) but it’s a very entertaining game, even if you are not looking for a new job.
…" property=og:description><meta content="index, nofollow" name=robots><meta content="Free Monads and Stockfighter" property=og:title><meta content=article property=og:type><meta content="https://perevillega.com/social_cards/index.png?h=125d02cc3c86eaf88fa6" property=og:image><meta content=2088 property=og:image:width><meta content=1000 property=og:image:height><meta content="https://perevillega.com/social_cards/index.png?h=125d02cc3c86eaf88fa6" name=twitter:image><meta content=summary_large_image name=twitter:card><meta content=en_GB property=og:locale><meta content=https://perevillega.com/posts/free-monads-and-stockfighter/ property=og:url><meta content="Software serves the Business" property=og:site_name><meta content="default-src 'self';font-src 'self' data: 'self';img-src 'self' https://* data:;media-src 'self' https://cdn.jsdelivr.net/;style-src 'self' 'unsafe-inline';frame-src player.vimeo.com https://www.youtube-nocookie.com;connect-src 'self' https://umami.villegawilcz.com;script-src 'self' https://umami.villegawilcz.com 'self'" http-equiv=Content-Security-Policy><noscript><link href=https://perevillega.com/no_js.css rel=stylesheet></noscript><script src=https://perevillega.com/js/initializeTheme.min.js></script><script defer src=https://perevillega.com/js/themeSwitcher.min.js></script><script async data-do-not-track=true data-website-id=7bdfa858-bebc-479d-9a1f-bea833a709a8 defer src=https://umami.villegawilcz.com/script.js></script><meta content=@pvillega@mastodon.social name=fediverse:creator><script src="https://perevillega.com/search_index.en.js?h=791a6da9678059241bea" defer></script><script src="https://perevillega.com/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://perevillega.com>Software serves the Business</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://perevillega.com/posts/> blog </a><li><a class="nav-links no-hover-padding" href=https://perevillega.com/tags/> tags </a></li><div class=nav-navs id=menu-icons-group><li class=js><div aria-label="Click or press $SHORTCUT to open search" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" id=search-button role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" class="theme-resetter arrow" title="Reset mode to default" aria-hidden=true role=button tabindex=0></div></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>Free Monads and Stockfighter</h1><ul class=meta><li>22nd Aug 2016<li title="2862 words"><span aria-hidden=true class=separator>•</span>15 min read<li class=tag><span aria-hidden=true class=separator>•</span>Tags: <li class=tag><a href=https://perevillega.com/tags/scala/>scala</a>, <li class=tag><a href=https://perevillega.com/tags/monad/>monad</a>, <li class=tag><a href=https://perevillega.com/tags/fp/>fp</a>, <li class=tag><a href=https://perevillega.com/tags/free-monad/>free monad</a>, <li class=tag><a href=https://perevillega.com/tags/stockfighter/>stockfighter</a></ul><section class=body><p><a href=https://www.stockfighter.io/ rel=noopener target=_blank>StockFighter</a> is a game by <a href=https://twitter.com/patio11/ rel=noopener target=_blank>Patrick McKenzie</a> (Hi Patrick!) and <a href=https://www.starfighters.io/about rel=noopener target=_blank>others</a> that makes you compete in a virtual Stock Exchange to accomplish certain objectives. They use it as a recruitment tool (kind of, read their website) but it’s a very entertaining game, even if you are not looking for a new job.</p><span id=continue-reading></span><p>Why am I talking about <a href=https://www.stockfighter.io/ rel=noopener target=_blank>StockFighter</a>? Well, as you can guess from the title, because <a href=http://typelevel.org/cats/tut/freemonad.html rel=noopener target=_blank>Free Monads</a>! Care to join?<h2 id=the-mission><a aria-label="Anchor link for: the-mission" class="header-anchor no-hover-padding" href=#the-mission><span aria-hidden=true class=link-icon></span></a> The Mission</h2><p><a href=https://www.stockfighter.io/ rel=noopener target=_blank>StockFighter</a> provides an environment which is limited in scope, but still complex enough that showcases limitations/strengths for a given tool. I’ve had in my backlog, for a looong while, the <em>mission</em> of completing the game. Building an API to do so using Free seemed like the perfect match.<p>The aim was to build a Free Monad wrapper on top of the <a href=https://starfighter.readme.io/docs/ rel=noopener target=_blank>Stockfighter API</a>, using <a href=https://github.com/ProjectSeptemberInc/freek rel=noopener target=_blank>Freek</a>, which allows us to solve the levels of the game. The API would only focus on the <em>Trading</em> part of the game as the other component, <em>Jailbreak</em>, is not fully ready to be used.<h2 id=caveats><a aria-label="Anchor link for: caveats" class="header-anchor no-hover-padding" href=#caveats><span aria-hidden=true class=link-icon></span></a> Caveats</h2><p>Before we start, I want to make you aware that I am a beginner regarding Free. I’ve heard a lot about the subject, and I previously wrote two posts about them: <a href=/understanding-free-monads>Free Monad</a> and <a href=/freek-and-free-monads>Freek and Free Monads</a> as a result of my research around the concept.<p>But these posts approached the subject in a very theoretical way; they described how to build a Free Monad and potential applications, but you don’t really understand something until you have used it in production or, at least, in a realistic environment.<p>This is my first <em>real(ish)</em> experience using Free for something more than a proof of concept, and as such I may have missed something obvious. If you believe so, please contact me via twitter (<a href=https://twitter.com/pvillega rel=noopener target=_blank>@pvillega</a>) as I’m very keen on fixing gaps in my knowledge :)<h2 id=the-implementation><a aria-label="Anchor link for: the-implementation" class="header-anchor no-hover-padding" href=#the-implementation><span aria-hidden=true class=link-icon></span></a> The Implementation</h2><p>Releasing your code to the public is scary, isn’t it? Oh, well, <a href=https://github.com/pvillega/stockfighter rel=noopener target=_blank>here you have it</a>. The code took longer than I wanted, as during its conception I realised several misconceptions I had regarding Free Monads and their implementation. I also experimented a bit with unrelated stuff which delayed this post <em>slightly</em> more. Ah, shiny baubles…<p>You may want to start by opening <code>Introduction.scala</code> and reading it top to bottom, as it exposes the API and usage cases.<p>If we ignore all the stuff not purely related to Free Monads, there are three files to focus on: <code>LogApi.scala</code>, <code>TradeApi.scala</code>, and <code>TradingAppHelpers.scala</code>.<h3 id=the-free-monads><a aria-label="Anchor link for: the-free-monads" class="header-anchor no-hover-padding" href=#the-free-monads><span aria-hidden=true class=link-icon></span></a> The Free Monads</h3><p>Files <code>LogApi.scala</code> and <code>TradeApi.scala</code> implement the Free Monads for the library. I won’t enter into the implementation details as they should be straightforward, and you can refer to my previous post on <a href=/freek-and-free-monads>Freek</a> for guidance.<p>What I want to discuss is: why these two DSL and not more?<p>We can argue about the abstraction levels, but I’ve come to these two as a natural evolution of the API. My initial idea was to build everything based on Free. When I say <em>everything</em> I mean it: my http calls would be a Free DSL (Get, Post, etc). Logs? Free. Free all the way down (and then turtles). It even sounded easy: Freek <a href=https://github.com/ProjectSeptemberInc/freek/blob/master/src/test/scala/AppSpec.scala rel=noopener target=_blank>examples</a> showcase a Log and Http DSL, so why not?<p>Well, it may be possible, in fact it’s my next aim (v 2.0?) to experiment more around this area. But it makes things more complex than needed.<p>Let’s take an example: Http DSL. Given the way natural transformations work, and that you want a generic DSL, you’ll end up with two DSL for your Http calls: a <em>request</em> one and one to manage <em>responses</em>. This is ok, the problem comes when you want to start defining <code>TradeAPI</code> using these DSL.<p>A natural transformation converts a monad into another. Although Free is a monad, I had lots of problems trying to compile a Natural transformation from <code>TradeApi.DSL</code> to <code>Task</code> that internally used <code>Http.DSL</code>, as it wasn’t a one-to-one transformation, but a one-to-for-comprehension transformation. It just didn’t work.<p>The easy solution was to implement the calls in <code>TradeApi</code> as for-comprehensions that used <code>Http.DSL</code> to define the behaviour. So <code>buy</code> would call the corresponding <code>Http.DSL</code> helpers, and so on. Something like:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">buy</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">stock</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">String</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-keyword z-control z-flow z-scala">for</span> <span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span><span class="z-source z-scala">	<span class="z-variable z-parameter z-scala">body</span> <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> <span class="z-support z-constant z-scala">Post</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>buyUrl<span class="z-punctuation z-separator z-scala">,</span> toBody<span class="z-punctuation z-section z-group z-begin z-scala">(</span>stock<span class="z-punctuation z-section z-group z-end z-scala">)</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span><span class="z-source z-scala">	<span class="z-variable z-parameter z-scala">rsp</span> <span class="z-keyword z-operator z-assignment z-scala">&LT-</span> <span class="z-support z-constant z-scala">DecodeResponse</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">OrderStatus</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span>body<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span><span class="z-source z-scala"><span class="z-punctuation z-section z-block z-end z-scala">}</span> <span class="z-keyword z-control z-flow z-scala">yield</span> rsp
</span></code></pre><p>At this point, though, we won’t have an interpreter for <code>TradeAPI</code>, only for <code>Http.DSL</code>. And there may be scenarios where we want to go that path. But, in this one, we may as well use our own interpreter for <code>TradeAPI</code> that manages the http calls and decoding inside, like a black box. We end up using a single interpreter anyway, but a slightly saner one.<p><code>LogApi</code> survived because, despite the option of doing the logging within the interpreter, it makes sense to allow the user to document the intention of programs built using <code>TradeAPI</code>.<p>So, in the end, we only need these two. Yes, we could go deeper and replace <code>TradeAPI</code> by several lower-level API, but the current form seemed simpler and more usable.<h3 id=helper-class><a aria-label="Anchor link for: helper-class" class="header-anchor no-hover-padding" href=#helper-class><span aria-hidden=true class=link-icon></span></a> Helper class</h3><p><code>TradingAppHelpers.scala</code> is mostly support methods and declarations: it defines the Onion we will use in our program, as well as some common methods like <code>run</code> to abstract calling the interpreter for our program and managing the lifecycle of our http client (to avoid leaking connections). I believe the comments in the file suffice to explain the intentions.<p>There are three parts of its code I want to elaborate a bit on.<h4 id=onion-type><a aria-label="Anchor link for: onion-type" class="header-anchor no-hover-padding" href=#onion-type><span aria-hidden=true class=link-icon></span></a> Onion type</h4><p>Below we have the declaration for API and Onion, as usual when using Freek to work with several DSL at once.<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-scala">type</span> <span class="z-entity z-name z-type z-scala">API</span> <span class="z-keyword z-operator z-assignment z-scala">= </span><span class="z-support z-class z-scala">LogApi</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-class z-scala">PRG</span> <span class="z-support z-type z-scala">:||:</span> <span class="z-support z-class z-scala">TradeApi</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-class z-scala">PRG</span>
</span><span class="z-source z-scala"><span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">API</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">Program</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">API</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span>
</span><span class="z-source z-scala"><span class="z-storage z-type z-scala">type</span> <span class="z-entity z-name z-type z-scala">O</span> <span class="z-keyword z-operator z-assignment z-scala">= </span><span class="z-support z-class z-scala">Result</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-variable z-language z-hole z-scala">?</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span> <span class="z-support z-type z-scala">:&:</span> <span class="z-support z-class z-scala">List</span> <span class="z-support z-type z-scala">:&:</span> <span class="z-support z-class z-scala">Bulb</span>
</span></code></pre><p>Note that the Onion declaration, <code>O</code>, includes both <code>Result</code> (an alias to <code>Xor</code>) and <code>List</code>. Without adding <code>List</code> I could not make it compile with result types of the form <code>Result[List[A]]</code>.<p>The side effect of this is that using the Onion causes all the programs to return <code>Result[List[A]]</code> results. We can avoid this if we know we won’t use a call that return <code>Result[List[A]]</code> inside a program. In that case we may avoid the Onion and obtain just <code>Result[A]</code> at the end (using <code>.freek</code> and not <code>.freeko</code>), but I’ve provided no helper methods similar to <code>run</code> for this use case. Feel free to send a pull-request with one ;)<p>There’s a better discussion on the matter in <a href=https://github.com/mandubian/freek/issues/5 rel=noopener target=_blank>this issue</a>.<h4 id=task-interpreter><a aria-label="Anchor link for: task-interpreter" class="header-anchor no-hover-padding" href=#task-interpreter><span aria-hidden=true class=link-icon></span></a> Task Interpreter</h4><p>Our Task interpreter, the natural transformation from the DSL to <code>Task</code>, is declared as:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">taskInterpreter</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">httpClient</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-comment z-block z-scala">/*...*/</span><span class="z-punctuation z-section z-group z-end z-scala">)</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-support z-constant z-scala">LogApiTaskInterpreter</span> :&: <span class="z-keyword z-other z-scala">new</span> <span class="z-support z-class z-scala">TradeApiTaskInterpreter</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-comment z-block z-scala">/*...*/</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></code></pre><p>In this implementation <code>TradeApiTaskInterpreter</code> depends on an <code>httpClient</code> to be able to contact Stockfighter. Encapsulating the <code>httpClient</code> inside the interpreter is problematic, as we can’t control the lifecycle of the client itself. At no point during the natural transformation are you aware that this is the last step (unless you add an explicit <em>last step</em> command, but kind of defeats the point). Which means that closing your http connections needs to be done outside the interpreter itself.<p>I know it sounds obvious, and it is. But the examples I’ve seen regarding interpreters and natural transformations showcase them as static objects with no dependencies, although the interpreters are the areas where we will perform side effects, like an http request. This mislead me, initially, to try to encapsulate everything inside the interpreter itself. I’m open to suggestions on improving the code, if you believe there’s a better way to manage the client.<h4 id=run-the-onion><a aria-label="Anchor link for: run-the-onion" class="header-anchor no-hover-padding" href=#run-the-onion><span aria-hidden=true class=link-icon></span></a> Run the Onion</h4><p>The code to run an interpreter on a given Onion is always the same, which means we can abstract it:<pre class="language-scala z-code" data-lang=scala><code class=language-scala data-lang=scala><span class="z-source z-scala"><span class="z-storage z-type z-function z-scala">def</span> <span class="z-entity z-name z-function z-scala">run</span><span class="z-meta z-generic z-scala"><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span></span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-variable z-parameter z-scala">program</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">OnionT</span><span class="z-punctuation z-definition z-generic z-begin z-scala">[</span><span class="z-support z-class z-scala">Free</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">API</span><span class="z-punctuation z-accessor z-scala">.</span><span class="z-support z-class z-scala">Cop</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">O</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-support z-class z-scala">A</span><span class="z-punctuation z-definition z-generic z-end z-scala">]</span><span class="z-punctuation z-separator z-scala">,</span> <span class="z-variable z-parameter z-scala">waitTime</span><span class="z-punctuation z-ascription z-scala">:</span> <span class="z-support z-class z-scala">Duration</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-constant z-numeric z-integer z-decimal z-scala">10</span> seconds<span class="z-punctuation z-section z-group z-end z-scala">)</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">client</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> <span class="z-keyword z-other z-scala">new</span> <span class="z-support z-class z-scala">GigahorseHttpClientManager</span><span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">    <span class="z-keyword z-control z-exception z-scala">try</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">interpreter</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> taskInterpreter<span class="z-punctuation z-section z-group z-begin z-scala">(</span>client<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      <span class="z-storage z-type z-stable z-scala">val</span> <span class="z-variable z-other z-constant z-scala">taskResult</span> <span class="z-keyword z-operator z-assignment z-scala">=</span> program<span class="z-punctuation z-accessor z-scala">.</span>value<span class="z-punctuation z-accessor z-scala">.</span>interpret<span class="z-punctuation z-section z-group z-begin z-scala">(</span>interpreter<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      <span class="z-support z-constant z-scala">Await</span><span class="z-punctuation z-accessor z-scala">.</span>result<span class="z-punctuation z-section z-group z-begin z-scala">(</span>taskResult<span class="z-punctuation z-accessor z-scala">.</span>runAsync<span class="z-punctuation z-separator z-scala">,</span> waitTime<span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    <span class="z-punctuation z-section z-block z-end z-scala">}</span></span> <span class="z-keyword z-control z-exception z-scala">finally</span> <span class="z-meta z-block z-scala"><span class="z-punctuation z-section z-block z-begin z-scala">{</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">      client<span class="z-punctuation z-accessor z-scala">.</span>close<span class="z-punctuation z-section z-group z-begin z-scala">(</span><span class="z-punctuation z-section z-group z-end z-scala">)</span>
</span></span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala"><span class="z-meta z-block z-scala">    <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></span><span class="z-source z-scala"><span class="z-meta z-block z-scala">  <span class="z-punctuation z-section z-block z-end z-scala">}</span></span>
</span></code></pre><p>As you can see the function <code>run</code> instantiates its own <code>TradeApiTaskInterpreter</code> to manage the <code>httpClient</code>, as discussed in the previous section.<p>The relevant part of this code is the type of the parameter <code>program</code>: <code>OnionT[Free, API.Cop, O, A]</code>. It’s another obvious thing, but when I tried to generalise the signature from my existing programs the values <code>sbt</code> gave me didn’t compile properly due to several implicit-related errors. Freek uses quite a few of them implicits, and you can find yourself in a tangle trying to derive the implicit you need for your program. Next time, just copy this method’s signature.<p>Or, as I discovered a bit too late (to my chagrin) pay more attention when reading the Freek instructions. That type is declared in the Readme file. D’oh!<h3 id=the-case-for-freek><a aria-label="Anchor link for: the-case-for-freek" class="header-anchor no-hover-padding" href=#the-case-for-freek><span aria-hidden=true class=link-icon></span></a> The case for Freek</h3><p>I want to explicitly comment on <a href=https://github.com/ProjectSeptemberInc/freek rel=noopener target=_blank>Freek</a>, as it deserves all praise I can give it.<p>My experience building these monads is a vindication for the library. Honestly, if you are going to use Free Monads in your code, add it to your dependencies. Right now. I’ll wait. Done?<p>I tried the Cats approach I described in my old post about <a href=/understanding-free-monads>Free Monad</a> to implement the API, stubborn in <em>keeping it simple and using few dependencies</em>. The pain was real, oh so real, when trying to work with the different answer types the DSL provides.<p>In fact, it didn’t work. Without Freek, the compiler was beating me. No chances, full surrender.<p>Yes, it is not perfect. For example see <a href=https://github.com/mandubian/freek/issues/5 rel=noopener target=_blank>this issue</a> related to the return types of Onions. It’s slightly cumbersome to having to manually peel responses each time you use the Onion. But given the alternative, I found it perfectly acceptable. And, come on, it’s barely version 0.6.0 and improving fast!<p>If you are a Scala magician at the level of Pascal, Travis, or Miles you may not need it. Otherwise, just use it and spend your valuable time in something else.<h2 id=what-are-free-monads-for><a aria-label="Anchor link for: what-are-free-monads-for" class="header-anchor no-hover-padding" href=#what-are-free-monads-for><span aria-hidden=true class=link-icon></span></a> What are Free Monads for</h2><p>Based on the, arguably limited, experience I’ve had while building the API and running programs using it there are several things to consider when using Free.<h3 id=free-monads-are-for-api><a aria-label="Anchor link for: free-monads-are-for-api" class="header-anchor no-hover-padding" href=#free-monads-are-for-api><span aria-hidden=true class=link-icon></span></a> Free Monads are for API</h3><p>Free Monads are intended to abstract your API. You define your DSLs, you build a program that uses them, and your construct interpreters to match. They are not for doing business logic, though.<p>What do I mean by that?<p>When I read about them, my naive mind thought you could buy a stack of Free on top of Free and only at the end you’d use the interpreter, creating a kind of pure universe untouched by side effects. Crazy, maybe.<p>Let’s start by the fact that Free doesn’t (can’t?) implement <code>filter</code>. This removes the capability of using <code>if</code> statements inside your for-comprehension. At some point in your application you’ll need to make decisions based on results, and avoiding <code>filter</code> gets complicated, fast.<p>For example, using the API provided try to create a program that buys a stock if the quote is lower than a value, and otherwise sells but only if you have enough shares and doing so would generate a benefit. Most likely you will end up with programs that mix Free statements with non-Free statements. You may argue the API is limited, so how complex do you want it to become to cover all particular once-off cases?<p>So, Free is great when you define a contract to hide implementation details. Think interfaces that do IO behind the scenes, or other side-effects, or combine calls to several services in one go. But it’s doubtful you’ll build your application (unless trivial) with <em>only</em> Free.<h3 id=ddd-ready><a aria-label="Anchor link for: ddd-ready" class="header-anchor no-hover-padding" href=#ddd-ready><span aria-hidden=true class=link-icon></span></a> DDD ready</h3><p><a href=https://en.wikipedia.org/wiki/Domain-driven_design rel=noopener target=_blank>DDD</a> is popular and you most likely use it. Bounded contexts and ubiquitous languages are a great fit for Free.<p>Your context is defined by a contract, an API that other components will use. Your logic will often use more than one context to achieve something, for example communicating with Authentication, User data, and Image storage to get the information it needs. Free are perfectly suited for this task.<h3 id=interpreters-are-your-io-monad><a aria-label="Anchor link for: interpreters-are-your-io-monad" class="header-anchor no-hover-padding" href=#interpreters-are-your-io-monad><span aria-hidden=true class=link-icon></span></a> Interpreters are your IO Monad</h3><p>I hear somebody screaming due to this statement. Apologies! But, in a sense, your interpreters can be considered a black box that will have side effects inside, which you don’t care much about.<p>Your Free programs define steps to be done against a certain API, but nothing else. They are pure, no side effects, nothing, just a list of steps. Only when interpreted is when they really do something useful.<p>This means all the side effects happen in your interpreter. And that is good. We want to isolate side-effects in our codebases, but when trying to do so we may end up with some cumbersome stuff:<blockquote><p>This is your return type: Int. This is your return type on microservices: IO (Logger (Either HttpError Int))<ul><li>Credit to <a href=https://twitter.com/krisajenkins/status/762901550696194048 rel=noopener target=_blank>Kris Jenkins</a></ul></blockquote><p>Jokes aside, we want to push side effects to the boundaries, which means we get horrible return types piling Task on top of Writer on top of Xor on top of any other monad we found. Within the interpreter we don’t need that. We know things will happen there, we can be ok with logging and running an IO fest within that black box. Because it’s isolated, and won’t leak, and we run it at the end, anyway.<p>And we get a cleaner return type as a consequence.<h3 id=interpreters-should-be-your-test-target><a aria-label="Anchor link for: interpreters-should-be-your-test-target" class="header-anchor no-hover-padding" href=#interpreters-should-be-your-test-target><span aria-hidden=true class=link-icon></span></a> Interpreters should be your test target</h3><p>In the codebase you’ll see a blunder I realised too late. Initially I tried to test programs by using an accumulating interpreter that stored the calls to the api in a State monad, returning some default values. This allowed me to compare expected output of the program vs the real output.<p>The accumulating interpreter can be good to see what happens with a program (print all the calls, to the bottom of the stack), but it’s not a great fit for testing due to hardcoded values. I experimented with another interpreter that allowed me to mock expected responses, so I could test most complex values, but this wasn’t ideal nor satisfactory.<p>Then I realised I was approaching it wrong.<p>Without Free, what I’d usually do is test a method for expected outputs given certain input. And that’s what I tried to do here. But with Free your method is nothing. I mean, it’s a description, so the test will be fully tangled with the program you defined.<p>What you want to test is the interpreter, or its core. You want to make sure the output for a given DSL call is what you expect. In our scenario, <code>TradeApiTaskInterpreter</code> uses a client to to http calls. The return types are enforced during compilation of the DSL (we know a call to <code>buy</code> will return an object of a certain type), but we may want to guarantee we are passing values like <code>price</code> or <code>quantity</code> correctly, or that if the http client returns an error we are capturing it and returning the proper <code>Left</code>.<p>This is where we want to focus our test efforts, which incidentally reduces the surface of code to be tested a lot, arguably giving us much robust code. Of course, there will be methods that mix Free monads with logical statements (if x call this monad, otherwise the other) which you will want to test as usual. But for methods that only use Free, focus on testing the interpreters.<h3 id=beware-the-layers><a aria-label="Anchor link for: beware-the-layers" class="header-anchor no-hover-padding" href=#beware-the-layers><span aria-hidden=true class=link-icon></span></a> Beware the layers</h3><p>I talked about it when discussing why I implemented the two DSL I chose, but it’s worth repeating.<p>Remember that your interpreter (as a natural transformation) has limitations. Start with the top level API and consider if you need a lower level DSL for your purposes. It may be, as in our case, that a single layer is good enough. It may as well be that you have a case that justifies building your Free on a lower layer.<p>In any case, stacking Free is not trivial and may cause pain. Thread carefully.<h3 id=they-are-not-easy><a aria-label="Anchor link for: they-are-not-easy" class="header-anchor no-hover-padding" href=#they-are-not-easy><span aria-hidden=true class=link-icon></span></a> They are not easy</h3><p>People talking about Free mention they are not easy and that new teams (or teams without much experience in functional programming) should not adopt them directly. I realised I didn’t fully understand the warning when I started using them for this library. They seem easy, they are misleadingly so. But you will find yourself scratching your head many, many times, due to subtleties that arise when using them.<p>Don’t underestimate them.<h2 id=aims-achieved><a aria-label="Anchor link for: aims-achieved" class="header-anchor no-hover-padding" href=#aims-achieved><span aria-hidden=true class=link-icon></span></a> Aims achieved?</h2><p>I have to make a confession: I’ve not completed StockFighter. I got sidetracked while experimenting with the API using their test server, so I’ve only solved the first (and trivial) level. Someday I’ll finish it :) I failed that aim.<p>But it’s been an enlightening experiment, which made me realise the limitations and strengths of Free. That said, it’s a first step on the path and most likely in a few months I’ll revisit this and realise I was wrong. But, hey, learning. Or something ;)<p>So, yes, Free Monad are useful, but they are no silver bullet. What a surprise, isn’t it? Like everything else in IT.<p>That’s all for now, I hope this was informative and useful. As always, feedback via Twitter/Email is more than welcome. Cheers!</section><nav class="full-width article-navigation"><div><a aria-describedby=left_title aria-label=Next href=https://perevillega.com/posts/learning-shapeless/><span class=arrow>←</span> Next</a><p aria-hidden=true id=left_title>Learning Shapeless</div><div><a aria-describedby=right_title aria-label=Prev href=https://perevillega.com/posts/freek-and-free-monads/>Prev <span class=arrow>→</span></a><p aria-hidden=true id=right_title>Free Monads using FreeK</div></nav></article></main><script defer src=https://perevillega.com/js/mermaid.min.js></script><span class=hidden id=copy-success> Copied! </span><span class=hidden id=copy-init> Copy code to clipboard </span><script defer src=https://perevillega.com/js/copyCodeToClipboard.min.js></script></div><footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://perevillega.com/atom.xml rel=noopener target=_blank> <img alt=feed loading=lazy src=https://perevillega.com/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email=cHZpbGxlZ2ErYmxvZ0BhcmFjb24uY29t href=#><img alt=email loading=lazy src=https://perevillega.com/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://github.com/pvillega target=_blank> <img alt=github loading=lazy src=https://perevillega.com/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://gitlab.com/pvillega target=_blank> <img alt=gitlab loading=lazy src=https://perevillega.com/social_icons/gitlab.svg title=gitlab> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://bsky.app/profile/perevillega.com target=_blank> <img alt=bluesky loading=lazy src=https://perevillega.com/social_icons/bluesky.svg title=bluesky> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://www.linkedin.com/in/perevillega/ target=_blank> <img alt=linkedin loading=lazy src=https://perevillega.com/social_icons/linkedin.svg title=linkedin> </a><li><a class="nav-links no-hover-padding social" rel="noopener me" href=https://stackoverflow.com/users/116791/pere-villega target=_blank> <img alt="stack overflow" title="stack overflow" loading=lazy src=https://perevillega.com/social_icons/stack-overflow.svg> </a></ul></nav><nav class=nav-navs><small> <ul><li><a class="nav-links no-hover-padding" href=https://perevillega.com/sitemap.xml> sitemap </a></ul> </small></nav><div class=credits><small> Powered by <a href=https://www.getzola.org rel=noopener target=_blank>Zola</a> & <a href=https://github.com/welpo/tabi rel=noopener target=_blank>tabi</a> </small></div></section><script async src=https://perevillega.com/js/decodeMail.min.js></script><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><h1 class=visually-hidden id=modalTitle>Search</h1><div id=modal-content><div id=searchBar><div aria-hidden=true class=search-icon><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search… role=combobox spellcheck=false><div class="close-icon interactive-icon" title="Clear search" id=clear-search role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></div></div><div id=results-container><div id=results-info><span id=zero_results> No results</span><span id=one_results> $NUMBER result</span><span id=many_results> $NUMBER results</span><span id=two_results> $NUMBER results</span><span id=few_results> $NUMBER results</span></div><div id=results role=listbox></div></div></div></div></footer>