<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=https://perevillega.com name=base><title>Software serves the Business • Ubuntu Server Maintenance</title><link href=https://perevillega.com/icons/favicon.ico rel=icon type=image/png><link title="Software serves the Business - Atom Feed" href=https://perevillega.com/atom.xml rel=alternate type=application/atom+xml><link href="https://perevillega.com/inter_subset_en.css?h=d8cf4ad058d6c3a4015b" rel=stylesheet><link href="https://perevillega.com/main.css?h=149ff9e737409b86f9c3" rel=stylesheet><link href="https://perevillega.com/custom.css?h=ff5a5712d2f0bc9d9ac2" rel=stylesheet><meta content="light dark" name=color-scheme><meta content=#087e96 name=theme-color><meta content="This guide will show some basic stuff you might need to maintain an Ubuntu server. You might not need all of them, but thy are handy enough and I've had to use them at least once.
…" name=description><meta content="This guide will show some basic stuff you might need to maintain an Ubuntu server. You might not need all of them, but thy are handy enough and I've had to use them at least once.
…" property=og:description><meta content="index, nofollow" name=robots><meta content="Ubuntu Server Maintenance" property=og:title><meta content=article property=og:type><meta content="https://perevillega.com/social_cards/index.png?h=125d02cc3c86eaf88fa6" property=og:image><meta content=2088 property=og:image:width><meta content=1000 property=og:image:height><meta content="https://perevillega.com/social_cards/index.png?h=125d02cc3c86eaf88fa6" name=twitter:image><meta content=summary_large_image name=twitter:card><meta content=en_GB property=og:locale><meta content=https://perevillega.com/posts/ubuntu-server-maintenance/ property=og:url><meta content="Software serves the Business" property=og:site_name><meta content="default-src 'self';font-src 'self' data: 'self';img-src 'self' https://* data:;media-src 'self' https://cdn.jsdelivr.net/;style-src 'self' 'unsafe-inline';frame-src 'self' player.vimeo.com https://www.youtube-nocookie.com https://view.officeapps.live.com;connect-src 'self' https://umami.villegawilcz.com;script-src 'self' https://umami.villegawilcz.com 'self'" http-equiv=Content-Security-Policy><noscript><link href=https://perevillega.com/no_js.css rel=stylesheet></noscript><script src=https://perevillega.com/js/initializeTheme.min.js></script><script defer src=https://perevillega.com/js/themeSwitcher.min.js></script><script async data-do-not-track=true data-website-id=7bdfa858-bebc-479d-9a1f-bea833a709a8 defer src=https://umami.villegawilcz.com/script.js></script><meta content=@pvillega@mastodon.social name=fediverse:creator><script src="https://perevillega.com/search_index.en.js?h=5e3427c9b8d057d8989e" defer></script><script src="https://perevillega.com/js/searchElasticlunr.min.js?h=3626c0ef99daa745b31e" defer></script><body><header><nav class=navbar><div class=nav-title><a class=home-title href=https://perevillega.com>Software serves the Business</a></div><div class=nav-navs><ul><li><a class="nav-links no-hover-padding" href=https://perevillega.com/posts/> blog </a><li><a class="nav-links no-hover-padding" href=https://perevillega.com/tags/> tags </a></li><div class=nav-navs id=menu-icons-group><li class=js><div aria-label="Click or press $SHORTCUT to open search" class="search-icon interactive-icon" title="Click or press $SHORTCUT to open search" id=search-button role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><li class="theme-switcher-wrapper js"><div aria-label="Toggle dark mode" title="Toggle dark/light mode" aria-pressed=false class=theme-switcher role=button tabindex=0></div><div aria-label="Reset mode to default" class="theme-resetter arrow" title="Reset mode to default" aria-hidden=true role=button tabindex=0></div></div></ul></div></nav></header><div class=content><main><article><h1 class=article-title>Ubuntu Server Maintenance</h1><ul class=meta><li>18th Aug 2009<li title="916 words"><span aria-hidden=true class=separator>•</span>5 min read<li class=tag><span aria-hidden=true class=separator>•</span>Tags: <li class=tag><a href=https://perevillega.com/tags/devops/>devops</a>, <li class=tag><a href=https://perevillega.com/tags/ubuntu/>ubuntu</a></ul><section class=body><p>This guide will show some basic stuff you might need to maintain an Ubuntu server. You might not need all of them, but thy are handy enough and I've had to use them at least once.</p><span id=continue-reading></span><h2 id=secure-a-fresh-ubuntu-installation><a aria-label="Anchor link for: secure-a-fresh-ubuntu-installation" class="header-anchor no-hover-padding" href=#secure-a-fresh-ubuntu-installation><span aria-hidden=true class=link-icon></span></a> Secure a fresh Ubuntu installation</h2><p>Original source: <a href=http://www.mensk.com/webmaster-toolbox/perfect-ubuntu-hardy-nginx-mysql5-php5-wordpress/>Mensk</a><p>When you install your fresh server, you have a completely unsafe Ubuntu installation. To make it a bit safer, follow these steps (change names and ports accordingly): Login as root (via ssh or using the console, it depends on your physical access to the machine) and change root password:<pre><code>passwd
</code></pre><p>Add new username - yourself:<pre><code>    adduser jsmith
    visudo
</code></pre><p>Append this line to end of file (to navigate within 'vi' editor to create next line - use these: L, $, a, <enter>): <pre><code>    jsmith ALL=(ALL) ALL
</code></pre> <p>To save and exit do: <esc>, :wq, <enter>. Now let's set up SSH configuration: <pre><code>    nano /etc/ssh/sshd_config
</code></pre> <p>Find Port 22 and change number to something different (12345) to make hacking more difficult.Then change the following settings:</p> <pre><code>    PermitRootLogin no
    X11Forwarding no
    UsePAM no
</code></pre> <p>Append these lines to the very end:</p> <pre><code>    UseDNS no
    AllowUsers jsmith
</code></pre> <p>After this, we must secure the server with iptables</p> <pre><code>    iptables-save > /etc/iptables.up.rules
    nano /etc/iptables.test.rules
</code></pre> <p>Copy contents of <a href=http://articles.slicehost.com/assets/2007/9/4/iptables.txt>this file</a> (content below) and paste it into 'iptables.test.rules'</p> <pre><code>    *filter


    #  Allows all loopback (lo0) traffic and drop all traffic to 127/8 that doesn't use lo0
    -A INPUT -i lo -j ACCEPT
    -A INPUT -i ! lo -d 127.0.0.0/8 -j REJECT


    #  Accepts all established inbound connections
    -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT


    #  Allows all outbound traffic
    #  You can modify this to only allow certain traffic
    -A OUTPUT -j ACCEPT


    # Allows HTTP and HTTPS connections from anywhere (the normal ports for websites)
    -A INPUT -p tcp --dport 80 -j ACCEPT
    -A INPUT -p tcp --dport 443 -j ACCEPT

    #  Allows SSH connections
    #
    # THE -dport NUMBER IS THE SAME ONE YOU SET UP IN THE SSHD_CONFIG FILE
    #
    -A INPUT -p tcp -m state --state NEW --dport 30000 -j ACCEPT

    # Allow ping
    -A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT


    # log iptables denied calls
    -A INPUT -m limit --limit 5/min -j LOG --log-prefix "iptables denied: " --log-level 7

    # Reject all other inbound - default deny unless explicitly allowed policy
    -A INPUT -j REJECT
    -A FORWARD -j REJECT

    COMMIT
</code></pre> <p>Change port number to your SSH port number on this line:</p> <pre><code>    -A INPUT -p tcp -m state --state NEW --dport 30000 -j ACCEPT
</code></pre> <p>Save and exit (Ctrl+O, Ctrl+X). To apply new iptables rules:</p> <pre><code>    iptables-restore < /etc/iptables.test.rules
</code></pre> <p>Then save iptables rules permanently:</p> <pre><code>    iptables-save > /etc/iptables.up.rules
</code></pre> <p>Make sure iptables rules will apply when server is rebooted as well:</p> <pre><code>    nano /etc/network/interfaces
</code></pre> <p>Add new line after these 2:</p> <pre><code>    auto lo

    iface lo inet loopbackpre-up iptables-restore < /etc/iptables.up.rules
</code></pre> <p>Save and exit. Reload SSH to use new ports and configurations:</p> <pre><code>     /etc/init.d/ssh reload
</code></pre> <p>Keep 'root' session running and open second session. SSH login to your slice to new port, with your new username and password:</p> <pre><code>    ssh -p 12345 jsmith@123.45.6.78
</code></pre> <p>If you logged on successfully via your new username: 'jsmith' - you may close 'root' session now. If not - you still have 'root' session opened to fix problems. As your user, edit .bashrc file to make terminal window a bit more helpful:</p> <pre><code>    nano ~/.bashrc
</code></pre> <p>Append these lines to the end of it:</p> <pre><code>    export PS1="\[\e[32;1m\]\u\[\e[0m\]\[\e[32m\]@\h\[\e[36m\]\w \[\e[33m\]\$ \[\e[0m\]"
    alias ll="ls -la"
    alias a2r="sudo /etc/init.d/apache2 stop && sleep 2 && sudo /etc/init.d/apache2 start"
    alias n2r="sudo /etc/init.d/nginx stop && sleep 2 && sudo /etc/init.d/nginx start"
    alias ver="cat /etc/lsb-release"
</code></pre> <p>Save and exit. Reload .bashrc to make changes active:</p> <pre><code>    source ~/.bashrc
</code></pre> <p>Update sources:</p> <pre><code>    sudo aptitude update
</code></pre> <p>Set system locale:</p> <pre><code>    sudo locale-gen en_US.UTF-8
    sudo /usr/sbin/update-locale LANG=en_US.UTF-8
</code></pre> <p>Upgrade system now:</p> <pre><code>    sudo aptitude -y safe-upgrade
    sudo aptitude -y full-upgrade
</code></pre> <h2 id=clean-the-server-via-ubuntugeek><a aria-label="Anchor link for: clean-the-server-via-ubuntugeek" class="header-anchor no-hover-padding" href=#clean-the-server-via-ubuntugeek><span aria-hidden=true class=link-icon></span></a> Clean the server (via <a href=http://www.ubuntugeek.com/ubucleaner-simple-bash-script-to-keep-your-ubuntu-system-clean.html>UbuntuGeek</a>)</h2> <p>I have a special fixation on cleaning my servers. I don't want any extra file (package, log, whatever) to be there if it is not needed. That's why when I discovered UbuntuCleaner I got quite happy. This tools does this for you:</p> <ul><li><p>Cleans apt cache</p><li><p>Removes config files left from uninstalled .deb packages(it happens if you don’t use the --purge switch with apt-get)</p><li><p>Removes every kernel except the one you are using</p><li><p>Empties the trashes of every user(including root)</p></ul> <p>It uses apt and the kernel removing thing searches for ubuntu-only packages, so it can’t work on non-debian system and the result is undetermined for other debian-based system, but you can still use the other features of the script(you’ll just have to comment the parts you don’t want).</p> <p>The script assumes that you are using the text-based Aptitude application, rather than apt-get and dpkg. If you are not using Aptitude, you should also replace the reference to aptitude clean with apt-get clean and the reference to aptitude purge to dpkg –purge.This can be done done by editing the following script. First you need to download the script from <a href="http://opendesktop.org/content/show.php/Ubucleaner?content=71529">here</a> or using the following command</p> <pre><code>    wget http://www.opendesktop.org/CONTENT/content-files/71529-ubucleaner.sh
</code></pre> <p>Now you should have 71529-ubucleaner.sh file you need to give execute permissions using the following command</p> <pre><code>    sudo chmod +x 71529-ubucleaner.sh
</code></pre> <p>Run the script using the following command</p> <pre><code>    ./71529-ubucleaner.sh
</code></pre> <h2 id=upgrading-to-a-new-release-via-howtoforge><a aria-label="Anchor link for: upgrading-to-a-new-release-via-howtoforge" class="header-anchor no-hover-padding" href=#upgrading-to-a-new-release-via-howtoforge><span aria-hidden=true class=link-icon></span></a> Upgrading to a new release (via <a href=http://www.howtoforge.com/how-to-upgrade-ubuntu-8.04-to-ubuntu-8.10-desktop-and-server>HowToForge</a>)</h2> <p>For an Ubuntu server, the main advice is to stick to LTS releases, due to their stability. That said, sometimes you might need to upgrade to a non-LTS release, as it happened to me when Launchpad was released and I wanted to install it (it required 9.04). So here I will describe the steps needed to update your distribution. It assumes you are running a server (no X11 installed) and this is your first upgrade:</p> <p>First become root:</p> <pre><code>    sudo su
</code></pre> <p>Then run</p> <pre><code>    apt-get update
</code></pre> <p>and install the package update-manager-core:</p> <pre><code>    apt-get install update-manager-core
</code></pre> <p>If you are running a LTS release, open the file /etc/update-manager/release-upgrades</p> <pre><code>    vi /etc/update-manager/release-upgrades
</code></pre> <p>and change Prompt=lts to Prompt=normal. Then run</p> <pre><code>    do-release-upgrade
</code></pre> <p>to start the distribution upgrade.</p> <h2 id=enabling-php-fastcgi-via-howtoforge><a aria-label="Anchor link for: enabling-php-fastcgi-via-howtoforge" class="header-anchor no-hover-padding" href=#enabling-php-fastcgi-via-howtoforge><span aria-hidden=true class=link-icon></span></a> Enabling PHP-FastCGI (via <a href=http://www.howtoforge.com/installing-nginx-with-php5-and-mysql-support-on-ubuntu-9.04>HowToForge</a>)</h2> <p>If you need to run fastcgi scripts on your Ubuntu 9.04 machine, you are lucky as this version provides a FastCGI-enabled PHP5 package. To activate it: Install PHP5 on Ubuntu:</p> <pre><code>    aptitude install php5-cgi php5-mysql php5-curl
    php5-gd php5-idn php-pear php5-imagick php5-imap php5-mcrypt
    php5-memcache php5-mhash php5-ming php5-pspell php5-recode php5-snmp
    php5-sqlite php5-tidy php5-xmlrpc php5-xsl
</code></pre> <p>Then open /etc/php5/cgi/php.ini and add the line</p> <pre><code>     cgi.fix_pathinfo = 1
</code></pre> <p>right at the end of the file. This enables the FastCGI package. But there's no standalone FastCGI daemon package for Ubuntu 9.04, therefore we use the spawn-fcgi program from lighttpd. We install lighttpd as follows:</p> <pre><code>    aptitude install lighttpd
    update-rc.d -f lighttpd remove
</code></pre> <p>so that lighttpd will not start at boot time, as we've installed lighttpd because we need just one program that comes with the package, /usr/bin/spawn-fcgi, which we can use to start FastCGI processes. Of course, you don't want to type in that command manually whenever you boot the system, so to have the system execute the command automatically at boot time, open /etc/rc.local</p> <pre><code>    vi /etc/rc.local
</code></pre> <p>and add the command at the end of the file (before the exit line):</p> <pre><code>    /usr/bin/spawn-fcgi -a 127.0.0.1 -p 9000 -u www-data -g www-data -f /usr/bin/php5-cgi -P /var/run/fastcgi-php.pid
</code></pre> <nav class="full-width article-navigation"><div><a aria-describedby=left_title aria-label=Next href=https://perevillega.com/posts/message-driven-beans/><span class=arrow>←</span> Next</a><p aria-hidden=true id=left_title>Message-Driven Beans</div><div><a aria-describedby=right_title aria-label=Prev href=https://perevillega.com/posts/redmine-on-ubuntu-9-dot-04-with-nginx/>Prev <span class=arrow>→</span></a><p aria-hidden=true id=right_title>Redmine on Ubuntu 9.04 with NGinx</div></nav> <script defer src=https://perevillega.com/js/mermaid.min.js></script><span class=hidden id=copy-success> Copied! </span> <span class=hidden id=copy-init> Copy code to clipboard </span> <script defer src=https://perevillega.com/js/copyCodeToClipboard.min.js></script> <footer><section><nav class="socials nav-navs"><ul><li><a class="nav-links no-hover-padding social" href=https://perevillega.com/atom.xml> <img alt=feed loading=lazy src=https://perevillega.com/social_icons/rss.svg title=feed> </a><li class=js><a class="nav-links no-hover-padding social" data-encoded-email=cHZpbGxlZ2ErYmxvZ0BhcmFjb24uY29t href=#><img alt=email loading=lazy src=https://perevillega.com/social_icons/email.svg title=email> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://github.com/pvillega> <img alt=github loading=lazy src=https://perevillega.com/social_icons/github.svg title=github> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://gitlab.com/pvillega> <img alt=gitlab loading=lazy src=https://perevillega.com/social_icons/gitlab.svg title=gitlab> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://bsky.app/profile/perevillega.com> <img alt=bluesky loading=lazy src=https://perevillega.com/social_icons/bluesky.svg title=bluesky> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://www.linkedin.com/in/perevillega/> <img alt=linkedin loading=lazy src=https://perevillega.com/social_icons/linkedin.svg title=linkedin> </a><li><a class="nav-links no-hover-padding social" rel=" me" href=https://stackoverflow.com/users/116791/pere-villega> <img alt="stack overflow" title="stack overflow" loading=lazy src=https://perevillega.com/social_icons/stack-overflow.svg> </a></ul></nav><nav class=nav-navs><small> <ul><li><a class="nav-links no-hover-padding" href=https://perevillega.com/sitemap.xml> sitemap </a></ul> </small></nav><div class=credits><small> Powered by <a href=https://www.getzola.org>Zola</a> & <a href=https://github.com/welpo/tabi>tabi</a> </small></div></section><script async src=https://perevillega.com/js/decodeMail.min.js></script><div class="search-modal js" aria-labelledby=modalTitle id=searchModal role=dialog><h1 class=visually-hidden id=modalTitle>Search</h1><div id=modal-content><div id=searchBar><div aria-hidden=true class=search-icon><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="M784-120 532-372q-30 24-69 38t-83 14q-109 0-184.5-75.5T120-580q0-109 75.5-184.5T380-840q109 0 184.5 75.5T640-580q0 44-14 83t-38 69l252 252-56 56ZM380-400q75 0 127.5-52.5T560-580q0-75-52.5-127.5T380-760q-75 0-127.5 52.5T200-580q0 75 52.5 127.5T380-400Z"/></svg></div><input aria-controls=results-container aria-expanded=false autocomplete=off id=searchInput placeholder=Search… role=combobox spellcheck=false><div class="close-icon interactive-icon" title="Clear search" id=clear-search role=button tabindex=0><svg viewbox="0 -960 960 960" xmlns=http://www.w3.org/2000/svg><path d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"/></svg></div></div><div id=results-container><div id=results-info><span id=zero_results> No results</span><span id=one_results> $NUMBER result</span><span id=many_results> $NUMBER results</span><span id=two_results> $NUMBER results</span><span id=few_results> $NUMBER results</span></div><div id=results role=listbox></div></div></div></div></footer> 