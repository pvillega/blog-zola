---
import type { GetStaticPaths } from 'astro';
import { getCollection, render } from 'astro:content';
import Layout from '~/layouts/PageLayout.astro';
import ServiceFeatures from '~/components/services/ServiceFeatures.astro';
import Button from '~/components/ui/Button.astro';
import { Icon } from 'astro-icon/components';

export const prerender = true;

export const getStaticPaths = (async () => {
  const services = await getCollection('services');
  return services.map((service) => ({
    params: { slug: service.id },
    props: { service },
  }));
}) satisfies GetStaticPaths;

const { service } = Astro.props;
const { Content } = await render(service);

const formatPrice = (amount: number, currency: string) => {
  if (currency === 'EUR') return `â‚¬${amount}`;
  if (currency === 'USD') return `$${amount}`;
  return `${amount} ${currency}`;
};

const metadata = {
  title: service.data.title,
  description: service.data.description,
};
---

<Layout metadata={metadata}>
  <section class="px-4 py-16 sm:px-6 mx-auto lg:px-8 lg:py-20 max-w-4xl">
    <!-- Breadcrumb -->
    <nav class="mb-8 text-sm">
      <ol class="flex items-center space-x-2 text-gray-600 dark:text-slate-400">
        <li><a href="/" class="hover:text-primary">Home</a></li>
        <li><Icon name="tabler:chevron-right" class="w-4 h-4" /></li>
        <li><a href="/services" class="hover:text-primary">Services</a></li>
        <li><Icon name="tabler:chevron-right" class="w-4 h-4" /></li>
        <li class="text-gray-900 dark:text-white">{service.data.title}</li>
      </ol>
    </nav>

    <!-- Header -->
    <header class="mb-12">
      <div class="flex items-center gap-3 mb-4">
        <h1 class="text-4xl md:text-5xl font-bold dark:text-white">{service.data.title}</h1>
        {
          service.data.featured && (
            <span class="px-3 py-1 text-xs font-semibold text-white bg-primary rounded-full">Featured</span>
          )
        }
      </div>
      {service.data.description && <p class="text-xl text-gray-600 dark:text-slate-400">{service.data.description}</p>}
    </header>

    <!-- Price Card -->
    {
      service.data.price && (
        <div class="mb-12 p-8 rounded-lg border-2 border-primary bg-gradient-to-br from-white to-gray-50 dark:from-slate-900 dark:to-slate-800">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
            <div>
              <div class="flex items-baseline gap-2 mb-2">
                <span class="text-5xl font-extrabold text-primary">
                  {formatPrice(service.data.price.amount, service.data.price.currency)}
                </span>
                {service.data.duration && (
                  <span class="text-xl text-gray-600 dark:text-slate-400">/ {service.data.duration}</span>
                )}
              </div>
              {service.data.type && (
                <div class="flex items-center gap-2 text-sm text-gray-600 dark:text-slate-400">
                  <Icon name="tabler:info-circle" class="w-4 h-4" />
                  <span>
                    {service.data.type === 'time-based' && 'Billed hourly'}
                    {service.data.type === 'deliverable' && 'Fixed price deliverable'}
                    {service.data.type === 'custom' && 'Custom pricing available'}
                  </span>
                </div>
              )}
            </div>
            <div class="flex flex-col gap-3 min-w-[200px]">
              <Button variant="primary" href={service.data.stripeLink || '/book'} class="w-full justify-center">
                <Icon name="tabler:shopping-cart" class="w-5 h-5 mr-2" />
                Book Now
              </Button>
              <Button variant="secondary" href="/contact" class="w-full justify-center">
                <Icon name="tabler:mail" class="w-5 h-5 mr-2" />
                Ask Questions
              </Button>
            </div>
          </div>
        </div>
      )
    }

    <!-- What's Included -->
    {
      service.data.includes && service.data.includes.length > 0 && (
        <ServiceFeatures includes={service.data.includes} columns={2} />
      )
    }

    <!-- Main Content -->
    <div class="prose prose-lg dark:prose-invert max-w-none mb-12">
      <Content />
    </div>

    <!-- CTA Footer -->
    <div class="mt-16 pt-8 border-t border-gray-200 dark:border-gray-700">
      <div class="text-center">
        <h3 class="text-2xl font-bold mb-4 dark:text-white">Ready to get started?</h3>
        <p class="text-gray-600 dark:text-slate-400 mb-6">
          Let's discuss how this service can help you achieve your goals.
        </p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <Button variant="primary" href={service.data.stripeLink || '/book'}>
            <Icon name="tabler:calendar" class="w-5 h-5 mr-2" />
            Schedule a Call
          </Button>
          <Button variant="secondary" href="/services">
            <Icon name="tabler:arrow-left" class="w-5 h-5 mr-2" />
            View All Services
          </Button>
        </div>
      </div>
    </div>
  </section>
</Layout>
