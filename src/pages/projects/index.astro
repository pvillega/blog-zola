---
import Layout from '~/layouts/PageLayout.astro';
import ProjectCard from '~/components/projects/ProjectCard.astro';
import { fetchProjects, getAllProjectTags } from '~/utils/projects';

export const prerender = true;

const projects = await fetchProjects();
const allTags = await getAllProjectTags();
const featuredProjects = projects.filter((p) => p.featured);

const metadata = {
  title: 'Projects',
  description: 'Portfolio of projects showcasing work in distributed systems, web development, and data engineering',
  robots: {
    index: true,
    follow: true,
  },
};
---

<Layout metadata={metadata}>
  <section class="px-6 sm:px-6 py-12 sm:py-16 lg:py-20 mx-auto max-w-6xl">
    <div class="mb-12">
      <h1 class="text-4xl md:text-5xl font-bold leading-tight mb-4 font-heading dark:text-slate-300">Projects</h1>
      <p class="text-xl text-muted dark:text-slate-400">
        A collection of projects showcasing work in distributed systems, web development, and data engineering
      </p>
    </div>

    <!-- Tag Filter Section -->
    {
      allTags.length > 0 && (
        <div class="mb-12">
          <h2 class="text-xl font-bold mb-4 dark:text-slate-300">Filter by Technology</h2>
          <div class="flex flex-wrap gap-3">
            <button
              data-filter="all"
              class="filter-btn bg-primary text-white px-4 py-2 rounded-lg font-medium hover:bg-primary-dark transition"
            >
              All ({projects.length})
            </button>
            <button
              data-filter="featured"
              class="filter-btn bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-slate-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-slate-600 transition"
            >
              Featured ({featuredProjects.length})
            </button>
            {allTags.map((tag) => (
              <button
                data-filter={tag.slug}
                class="filter-btn bg-gray-200 dark:bg-slate-700 text-gray-700 dark:text-slate-300 px-4 py-2 rounded-lg font-medium hover:bg-gray-300 dark:hover:bg-slate-600 transition"
              >
                {tag.title} ({tag.count})
              </button>
            ))}
          </div>
        </div>
      )
    }

    <!-- Projects Grid -->
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      {
        projects.map((project) => (
          <div
            class="project-item"
            data-tags={project.tags?.map((t) => t.slug).join(',')}
            data-featured={project.featured}
          >
            <ProjectCard project={project} />
          </div>
        ))
      }
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="hidden text-center py-12">
      <p class="text-xl text-muted dark:text-slate-400">No projects found matching the selected filter.</p>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const filterButtons = document.querySelectorAll('.filter-btn');
      const projectItems = document.querySelectorAll('.project-item');
      const noResults = document.getElementById('no-results');

      filterButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const filter = button.getAttribute('data-filter');
          if (!filter) return;

          // Update active button styling
          filterButtons.forEach((btn) => {
            btn.classList.remove('bg-primary', 'text-white');
            btn.classList.add('bg-gray-200', 'dark:bg-slate-700', 'text-gray-700', 'dark:text-slate-300');
          });
          button.classList.remove('bg-gray-200', 'dark:bg-slate-700', 'text-gray-700', 'dark:text-slate-300');
          button.classList.add('bg-primary', 'text-white');

          // Filter projects
          let visibleCount = 0;
          projectItems.forEach((item) => {
            const tags = item.getAttribute('data-tags')?.split(',') || [];
            const isFeatured = item.getAttribute('data-featured') === 'true';
            let shouldShow = false;

            if (filter === 'all') {
              shouldShow = true;
            } else if (filter === 'featured') {
              shouldShow = isFeatured;
            } else {
              shouldShow = tags.includes(filter);
            }

            if (shouldShow) {
              item.classList.remove('hidden');
              visibleCount++;
            } else {
              item.classList.add('hidden');
            }
          });

          // Show/hide no results message
          if (visibleCount === 0) {
            noResults?.classList.remove('hidden');
          } else {
            noResults?.classList.add('hidden');
          }
        });
      });
    });
  </script>
</Layout>
